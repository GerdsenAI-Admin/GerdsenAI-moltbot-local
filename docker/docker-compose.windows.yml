# Moltbot Local AI for Windows
# Works with Docker Desktop + WSL2
#
# Requirements:
#   - Docker Desktop with WSL2 backend
#   - For GPU: NVIDIA Container Toolkit in WSL2
#
# Usage:
#   docker compose -f docker/docker-compose.windows.yml up -d
#
# Note: For GPU support, you must:
#   1. Install WSL2 with Ubuntu
#   2. Install NVIDIA drivers on Windows
#   3. Install NVIDIA Container Toolkit in WSL2

services:
  # ===========================================================================
  # Ollama - Most Windows-compatible option
  # Works with CPU, optional GPU via WSL2
  # ===========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: moltbot-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_NUM_PARALLEL=2
    restart: unless-stopped
    # Windows-compatible healthcheck (no curl dependency)
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:11434/api/version || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================================================
  # Chroma Vector DB
  # ===========================================================================
  chroma:
    image: chromadb/chroma:latest
    container_name: moltbot-chroma
    ports:
      - "8000:8000"
    volumes:
      - chroma-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=FALSE
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:8000/api/v1/heartbeat || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Qdrant Vector DB (alternative)
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: moltbot-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    restart: unless-stopped
    profiles:
      - qdrant

  # ===========================================================================
  # CPU-only Embeddings (for Windows without GPU)
  # ===========================================================================
  embeddings:
    image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.5
    container_name: moltbot-embeddings
    ports:
      - "8081:80"
    volumes:
      - embeddings-data:/data
    command: ["--model-id", "BAAI/bge-small-en-v1.5", "--port", "80"]
    restart: unless-stopped
    profiles:
      - embeddings

  # ===========================================================================
  # CPU-only Reranker (for Windows without GPU)
  # ===========================================================================
  reranker:
    image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.5
    container_name: moltbot-reranker
    ports:
      - "8082:80"
    volumes:
      - reranker-data:/data
    command: ["--model-id", "BAAI/bge-reranker-base", "--port", "80"]
    restart: unless-stopped
    profiles:
      - reranker

volumes:
  ollama-data:
  chroma-data:
  qdrant-data:
  embeddings-data:
  reranker-data:

networks:
  default:
    name: moltbot-windows
